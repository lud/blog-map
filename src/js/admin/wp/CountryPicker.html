<div class="alpha2-status {statusClass}">
  {#if editing}
    <input ref:locationInput
      on:blur="endEditMode(false)"
      list="country-names-data"
      name="countryAlpha2"
      placeholder="{countryName}"
      on:keyup="onNameInput(this.value)"
      on:change="onNameInput(this.value, true)">
  	<span class="status-bg">{statusText}</span>
  {:else}
    <span on:click="startEditMode()" class="status-bg">{countryName} [{value || '?'}]</span>
  {/if}
</div>

<script>
import { countries } from 'country-data'
const countryNameToAlpha2 = {}
countries.all.forEach(c => {
  countryNameToAlpha2[c.name] = c.alpha2
})

export default {
  data() {
    return {
      value: null,
      editingValue: null,
      editing: false,
      lastInput: ''
    }
  },
  computed: {
    liveValue: ({editing, editingValue, value}) => {
    	return editing ? editingValue : value
    },
    status: ({liveValue}) => {
      return !!countries[liveValue]
    },
    statusClass: ({status}) => {
      return 'status-' + (status ? 'success' : 'error')
    },
    statusText: ({status, liveValue, lastInput}) => {
    	return status ? 'OK' : lastInput !== '' ? ' (Not found)' : ''
    },
    countryName: ({liveValue, lastInput}) => {
    	return (countries[liveValue] || {name: lastInput}).name
    }
  },
	onstate({ changed, current, previous }) {
		if (changed.value) {
      console.log('CountryPicker change', current.value)
    	this.fire('change', current.value)
		}
	},
  methods: {
    onNameInput(countryName, commitValue) {
      const editingValue = countryNameToAlpha2[countryName] || null
      this.set({ editingValue: editingValue, lastInput: countryName })
      if (commitValue) {
				this.endEditMode(true)
      }
    },
    startEditMode() {
    	this.set({ editing: true, editingValue: null, lastInput: '' })
    	this.refs.locationInput.focus()
    },
    endEditMode(commitValue) {
      console.log('CountryPicker end edit mode, commit:%s', commitValue)
    	if (this.get().editing) {
	    	this.set({ editing: false })
	    	if (commitValue) {
          console.log('commit')
	    		const { editingValue } = this.get()
	    		this.set({ value: editingValue })
	    	}
    	}
    }
  }
}
</script>

<style>
  .status-bg {
    color: grey;
  }
  .alpha2-status.status-error .status-bg {
    background-color: #fcc;
  }
  .alpha2-status.status-success .status-bg {
    background-color: #cfc;
  }
  .alpha2-status.status-error input {
    box-shadow:inset 0 0 5px 5px #fcc;
  }
  .alpha2-status.status-success input {
    box-shadow:inset 0 0 5px 5px #cfc;
  }
</style>
